---
title: "식료품 연관 규칙 분석"
output: html_notebook
---
<br>
식료품 매장의 거래 데이터에 대해 장바구니 분석을 수행
<br>
<br>

### 1. 데이터 수집
arules R 패키지의 Groceries 데이터셋
- 식료품 매장의 한 달 간의 구매 데이터
- 9,835건의 거래, 169개의 아이템
<br>
<br>

### 2. 데이터 탐색과 전처리
Groceries 데이터는 transaction 형식으로 제공되어진다.

```{r}
install.packages(c("arules", "arulesViz"))
library(arules)
library(arulesViz)
data(Groceries)
```
<br>
<br>
행렬에서 0이 아닌 셀의 비율인 density 값을 보면 9835 x 169 x 0.02609146 = 43367개의 아이템이 구매되었으며 평균 거래는 43367 / 9835  4.409 개의 다른 아이템을 포함하고 있다. 가장 흔히 구매한 아이템은 whole milk, other vegetables, rolls/buns, soda 등이다.
```{r}
summary(Groceries)
```
<br>
<br>
희소 행렬의 내용을 확인할 수 있다.
```{r}
inspect(head(Groceries))
```
<br>
<br>
해당 아이템을 포함하는 거래의 비율을 확인할 수 있다. 즉, 각 아이템에 대한 지지도를 확인할 수 있다.
```{r}
itemFrequency(Groceries)
```
<br>
<br>
최소 10%의 지지도를 갖는 아이템을 확인해보자.
```{r}
itemFrequencyPlot(Groceries, support=0.1)
```
<br>
<br>
상위 20개의 아이템의 지지도를 확인해보자.
```{r}
itemFrequencyPlot(Groceries, topN = 20)
```
<br>
<br>
희소 행렬을 개략적으로 확인해보자. 전체 희소 행렬은 매우 크기 때문에 부분 집합을 사용하여 확인한다. 처음 다섯 개의 거래에 대한 희소 행렬을 확인해보자.
아이템은 열로 표현되며 해당 아이템을 구매한 거래가 행으로 나타나 검정색으로 채워진다. 이를 통해 1, 4, 5 번째 거래는 각각 네 개의 아이템을 포함하고 있다는 것을 알 수 있다.
```{r}
image(Groceries[1:5])
```
<br>
<br>
다음으로는 임의의 100개 거래를 선택하여 희소 행렬을 확인해보자. 점의 분포는 대체적으로 랜덤하게 보이므로 분석을 계속 진행한다.
```{r}
image(sample(Groceries, 100))
```
<br>
<br>
<br>

### 3. 모델 훈련
<br>
arules 패키지의 아프리오리 알고리즘을 사용하여 장바구니 아이템 간의 연관성을 찾아보자.
우선, 연관 규칙을 찾는다. 최소 규칙 지지도가 0.006 이고, 최소 규칙 신뢰도는 0.25, 최소 규칙 아이템은 2개인 연관 규칙을 찾아본다.
```{r}
groceryrules <- apriori(Groceries, parameter = list(support = 0.006, confidence = 0.25, minlen = 2))
groceryrules
```
<br>
총 463개의 연관 규칙이 발견되었으며 이 중 어떤 것이 유용한지 확인해보자.
<br>
<br>
<br>

### 4. 모델 성능 평가
<br>
규칙 집합의 특성을 확인하고 규칙 품질 척도인 지지도, 신뢰도, 향상도의 요약 통계를 확인해보자.
```{r}
summary(groceryrules)
```
<br>
<br>
처음 세 개의 규칙을 관찰해보자.
'화분에 심겨진 식물을 산다면 전유도 살 것이다' 라는 첫 번째 규칙은 지지도가 0.007이고 신뢰도가 0.400으로 전체 거래의 0.7 %를 차지하며 화분에 심겨진 식물의 거래의 40%에서 이 규칙이 옳다고 볼 수 있다. 향상도는 1.56으로 유의미한 규칙이라고 볼 수 있다. 하지만 일반적으로 생각해보면 이 규칙은 유용한 규칙이라고 보긴 어렵다. 따라서 '설명하기 어려운' 규칙으로 분류하는 것이 타당할 것이다.
```{r}
inspect(groceryrules[1:3])
```
<br>
lift 기준으로 상위 20개의 규칙을 시각화하면 다음과 같다.
```{r}
toprules <- head(sort(groceryrules, by="lift"), 20)
plot(toprules, method="graph", control=list(type="items"))

```
<br>
<br>
<br>

### 5. 모델 성능 개선
<br>
결과를 더욱 활용 가능하게 만들어 규칙의 성능을 개선해보자.
<br>
<br>
**연관 규칙 집합 정렬**
연관 규칙을 정렬하여 lift 값이 큰 즉, 향상도의 측면에서 최고의 다섯개의 규칙을 검토해보자.
모델 성능 평가에서 보았던 규칙보다는 좀 더 유의미한 결과들을 확인할 수 있다. 
첫 번째 규칙은 '허브를 산다면 뿌리 채소를 살 것이다`라는 규칙으로, 이는 뿌리 채소를 산 일반 고객보다 거의 4배 정도 높다는 것을 알 수 있다. 두 번째 규칙은 '베리를 산다면 휘핑크림을 살 것이다'라는 규칙으로 휘핑크림이 다른 장바구니에 비해 베리가 포함된 장바구니에서 발견될 가능성이 3배 이상 높다는 것을 의미한다.
```{r}
inspect(sort(groceryrules, by = "lift")[1:5])
```
<br>
<br>
**연관 규칙의 부분집합 구하기**
두 번째 규칙을 채택한다면 우선, 베리를 포함하는 모든 규칙을 확인해볼 필요가 있다.
베리를 포함하는 규칙은 총 4개이고 이 중 향상도가 높은 첫 번째와 두 번째 규칙을 선택할 수 있겠다.
```{r}
berryrules <- subset(groceryrules, items %in% "berries")
inspect(berryrules)
```
<br>
<br>
**연관규칙 시각화**
베리의 연관 규칙을 시각화해서 나타내보자.
```{r}
plot(berryrules, method = "graph", control = list(type="items"))
```
<br>
<br>
```{r}
plot(berryrules, method = "paracoord", control = list(recorder=TRUE))
```